---
author: 
  name: jeffery
  link: https://github.com/JefferyXZF
title: Eggjs 搭建 Gitlab webhook 企业微信机器人
date: 2021-03-16 10:04:14
permalink: /pages/fekeeeeao556/
categories: 
  - gitlab
  - 工具
tags: 
  - gitlab
  - 工具
---

# Eggjs 搭建 Gitlab webhook 企业微信机器人


[Gitlab 中文文档](https://www.bookstack.cn/read/gitlab-doc-zh/README.md)

`Gitlab` 提供 `webhook` 钩子，当 `push、tag push、merge request、pipeline` 等操作会触发 `webhook` 钩子函数执行, 请求 `webhook` 链接地址，`gitlab` 会把携带 `git` 提交的信息，在接口那里就可以通过请求头拿到需要的信息，在后台进行逻辑处理，然后调用企业微信提供的的 [API](https://open.work.weixin.qq.com/api/doc/90000/90136/91770) ，企业机器人调用服务发起通知。所以，关键的核心步骤需要搭建一个中间服务，这里使用 [eggjs](https://eggjs.org/zh-cn/intro/) 框架搭建

## 创建 webhook

在 `gitlab` 的 webhook `URL` 上粘贴一条链接, 选择触发事件，点击 `Add webhook` 就可以创建一条 `webhook`

[![挂载流程图](https://gitee.com/FIF/pic-beg/raw/master/images/vue/webhook.png)](https://jefferyxzf.github.io/images/gitlab/webhook.png)

中间服务搭建好后，可以测试 `webhook` ，点击 `Test` 可以选择触发的事件

[![挂载流程图](https://gitee.com/FIF/pic-beg/raw/master/images/vue/webhook-test.png)](https://jefferyxzf.github.io/images/gitlab/webhook-test.png)

### push 事件

当提交代码 `push` 后，会把下面的对象放在请求头中，从中可以取出我们需要的信息

- `object_kind`： 值是 `push`, 为 push 提交代码操作
- `ref`： 知道代码提交分支
- `user_name`： 提交人姓名
- `user_username`：提交人帐号
- `project`：通过 `name` 知道项目名称
- `commits`：`timestamp`、`url` 和 `msg` 可以拿到提交代码时间、提交代码路径、commit 信息记录

```js
{
  "object_kind": "push",
  "before": "95790bf891e76fee5e1747ab589903a6a1f80f22",
  "after": "da1560886d4f094c3e6c9ef40349f7d38b5d27d7",
  "ref": "refs/heads/master",
  "checkout_sha": "da1560886d4f094c3e6c9ef40349f7d38b5d27d7",
  "user_id": 4,
  "user_name": "John Smith",
  "user_username": "jsmith",
  "user_email": "john@example.com",
  "user_avatar": "https://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=8://s.gravatar.com/avatar/d4c74594d841139328695756648b6bd6?s=80",
  "project_id": 15,
  "project":{
    "id": 15,
    "name":"Diaspora",
    "description":"",
    "web_url":"http://example.com/mike/diaspora",
    "avatar_url":null,
    "git_ssh_url":"git@example.com:mike/diaspora.git",
    "git_http_url":"http://example.com/mike/diaspora.git",
    "namespace":"Mike",
    "visibility_level":0,
    "path_with_namespace":"mike/diaspora",
    "default_branch":"master",
    "homepage":"http://example.com/mike/diaspora",
    "url":"git@example.com:mike/diaspora.git",
    "ssh_url":"git@example.com:mike/diaspora.git",
    "http_url":"http://example.com/mike/diaspora.git"
  },
  "repository":{
    "name": "Diaspora",
    "url": "git@example.com:mike/diaspora.git",
    "description": "",
    "homepage": "http://example.com/mike/diaspora",
    "git_http_url":"http://example.com/mike/diaspora.git",
    "git_ssh_url":"git@example.com:mike/diaspora.git",
    "visibility_level":0
  },
  "commits": [
    {
      "id": "b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327",
      "message": "Update Catalan translation to e38cb41.",
      "timestamp": "2011-12-12T14:27:31+02:00",
      "url": "http://example.com/mike/diaspora/commit/b6568db1bc1dcd7f8b4d5a946b0b91f9dacd7327",
      "author": {
        "name": "Jordi Mallach",
        "email": "jordi@softcatala.org"
      },
      "added": ["CHANGELOG"],
      "modified": ["app/controller/application.rb"],
      "removed": []
    },
    {
      "id": "da1560886d4f094c3e6c9ef40349f7d38b5d27d7",
      "message": "fixed readme",
      "timestamp": "2012-01-03T23:36:29+02:00",
      "url": "http://example.com/mike/diaspora/commit/da1560886d4f094c3e6c9ef40349f7d38b5d27d7",
      "author": {
        "name": "GitLab dev user",
        "email": "gitlabdev@dv6700.(none)"
      },
      "added": ["CHANGELOG"],
      "modified": ["app/controller/application.rb"],
      "removed": []
    }
  ],
  "total_commits_count": 4
}
```



## merge_request

当发起合并、合并完成、关闭合并，会触发 `merge_request` 钩子，通过 `object_attributes.state` 值判断不同的操作，简单介绍一下需要的关键信息

- user: 提交人
- object_attributes
  - state：合并操作，opened - 发起合并，merged - 合并成功，closed - 关闭合并
  - url：合并详细地址
  - target_branch：合并目标分支
  - source_branch：合并源分支
  - created_at：合并时间

```js
{
  "object_kind": "merge_request",
  "user": {
    "name": "Administrator",
    "username": "root",
    "avatar_url": "http://www.gravatar.com/avatar/e64c7d89f26bd1972efa854d13d7dd61?s=40\u0026d=identicon"
  },
  "project": {
    "id": 1,
    "name":"Gitlab Test",
    "description":"Aut reprehenderit ut est.",
    "web_url":"http://example.com/gitlabhq/gitlab-test",
    "avatar_url":null,
    "git_ssh_url":"git@example.com:gitlabhq/gitlab-test.git",
    "git_http_url":"http://example.com/gitlabhq/gitlab-test.git",
    "namespace":"GitlabHQ",
    "visibility_level":20,
    "path_with_namespace":"gitlabhq/gitlab-test",
    "default_branch":"master",
    "homepage":"http://example.com/gitlabhq/gitlab-test",
    "url":"http://example.com/gitlabhq/gitlab-test.git",
    "ssh_url":"git@example.com:gitlabhq/gitlab-test.git",
    "http_url":"http://example.com/gitlabhq/gitlab-test.git"
  },
  "repository": {
    "name": "Gitlab Test",
    "url": "http://example.com/gitlabhq/gitlab-test.git",
    "description": "Aut reprehenderit ut est.",
    "homepage": "http://example.com/gitlabhq/gitlab-test"
  },
  "object_attributes": {
    "id": 99,
    "target_branch": "master",
    "source_branch": "ms-viewport",
    "source_project_id": 14,
    "author_id": 51,
    "assignee_id": 6,
    "title": "MS-Viewport",
    "created_at": "2013-12-03T17:23:34Z",
    "updated_at": "2013-12-03T17:23:34Z",
    "milestone_id": null,
    "state": "opened",
    "merge_status": "unchecked",
    "target_project_id": 14,
    "iid": 1,
    "description": "",
    "source": {
      "name":"Awesome Project",
      "description":"Aut reprehenderit ut est.",
      "web_url":"http://example.com/awesome_space/awesome_project",
      "avatar_url":null,
      "git_ssh_url":"git@example.com:awesome_space/awesome_project.git",
      "git_http_url":"http://example.com/awesome_space/awesome_project.git",
      "namespace":"Awesome Space",
      "visibility_level":20,
      "path_with_namespace":"awesome_space/awesome_project",
      "default_branch":"master",
      "homepage":"http://example.com/awesome_space/awesome_project",
      "url":"http://example.com/awesome_space/awesome_project.git",
      "ssh_url":"git@example.com:awesome_space/awesome_project.git",
      "http_url":"http://example.com/awesome_space/awesome_project.git"
    },
    "target": {
      "name":"Awesome Project",
      "description":"Aut reprehenderit ut est.",
      "web_url":"http://example.com/awesome_space/awesome_project",
      "avatar_url":null,
      "git_ssh_url":"git@example.com:awesome_space/awesome_project.git",
      "git_http_url":"http://example.com/awesome_space/awesome_project.git",
      "namespace":"Awesome Space",
      "visibility_level":20,
      "path_with_namespace":"awesome_space/awesome_project",
      "default_branch":"master",
      "homepage":"http://example.com/awesome_space/awesome_project",
      "url":"http://example.com/awesome_space/awesome_project.git",
      "ssh_url":"git@example.com:awesome_space/awesome_project.git",
      "http_url":"http://example.com/awesome_space/awesome_project.git"
    },
    "last_commit": {
      "id": "da1560886d4f094c3e6c9ef40349f7d38b5d27d7",
      "message": "fixed readme",
      "timestamp": "2012-01-03T23:36:29+02:00",
      "url": "http://example.com/awesome_space/awesome_project/commits/da1560886d4f094c3e6c9ef40349f7d38b5d27d7",
      "author": {
        "name": "GitLab dev user",
        "email": "gitlabdev@dv6700.(none)"
      }
    },
    "work_in_progress": false,
    "url": "http://example.com/diaspora/merge_requests/1",
    "action": "open",
    "assignee": {
      "name": "User1",
      "username": "user1",
      "avatar_url": "http://www.gravatar.com/avatar/e64c7d89f26bd1972efa854d13d7dd61?s=40\u0026d=identicon"
    }
  },
  "labels": [{
    "id": 206,
    "title": "API",
    "color": "#ffffff",
    "project_id": 14,
    "created_at": "2013-12-03T17:15:43Z",
    "updated_at": "2013-12-03T17:15:43Z",
    "template": false,
    "description": "API related issues",
    "type": "ProjectLabel",
    "group_id": 41
  }],
  "changes": {
    "updated_by_id": [null, 1],
    "updated_at": ["2017-09-15 16:50:55 UTC", "2017-09-15 16:52:00 UTC"],
    "labels": {
      "previous": [{
        "id": 206,
        "title": "API",
        "color": "#ffffff",
        "project_id": 14,
        "created_at": "2013-12-03T17:15:43Z",
        "updated_at": "2013-12-03T17:15:43Z",
        "template": false,
        "description": "API related issues",
        "type": "ProjectLabel",
        "group_id": 41
      }],
      "current": [{
        "id": 205,
        "title": "Platform",
        "color": "#123123",
        "project_id": 14,
        "created_at": "2013-12-03T17:15:43Z",
        "updated_at": "2013-12-03T17:15:43Z",
        "template": false,
        "description": "Platform related issues",
        "type": "ProjectLabel",
        "group_id": 41
      }]
    }
  }
}
```



## 搭建中间服务

使用 [eggjs](https://eggjs.org/zh-cn/intro/quickstart.html) 框架快速搭建项目

```shell
$ mkdir gitlab-webhook && cd gitlab-webhook
$ npm init egg --type= // 初始化项目
$ npm i // 按照依赖
```



**创建路由**

```js
// gitlab-webhook/app/router.js

module.exports = app => {
  const { router, controller } = app;
  router.get('/', controller.home.index);
  router.post('/webhook/:key', controller.home.webhook);
};
```



**创建控制器类**

```js
// gitlab-webhook/app/controller/home.js

'use strict';

const Controller = require('egg').Controller;
const config = require('../../config/config');
const events = require('../core/events/index');

class HomeController extends Controller {
  async index() {
    const { ctx } = this;
    ctx.body = 'hi, egg';
  }
  // gitlab webhook && 企业微信机器人
  async webhook() {
    const { ctx, app } = this;
    const body = ctx.request.body;

    const key = ctx.params.key;
    if (!key) return;

    // 拼接 webhook 链接地址，发送企业微信机器人地址
    const webhook = config.baseWebhook + key;

    try {
      const eventType = body.object_kind;
      // push 推送事件
      if (eventType === 'push') {
        await events.pushEvent(ctx, webhook, body);
      } else if (eventType === 'merge_request') {
        await events.mergeEvent(ctx, webhook, body);
      }
    } catch (ex) {
      console.log(ex);
      this.ctx.body = '请求参数不合法';
    }
  }
}

module.exports = HomeController;
```



**pull 事件处理**

```js
// gitlab-webhook/core/event/push.js

'use strict';

const config = require('../../../config/config');
const utils = require('../utils/index');

async function pushEvent(ctx, webhook, body) {
  try {
    const { project, commits, ref } = body;
    // 提交人
    const commitPerson = config.commitPeople[body.user_username] || config.commitPeople[body.user_name];
    const username = commitPerson && commitPerson.name || body.user_name;

    // 提交记录
    const commit = Array.isArray(commits) && commits[commits.length - 1];
    const dateFormat = utils.getDateFormat(commit.timestamp);
    const lastCommit = commit.message;
    const pushUrl = commit.url;
    const projectName = project.name;

    const receivers = config.receivers;
    // 验证接收者
    if (!(commitPerson || receivers.includes(username))) {
      return;
    }

    let sourceBranch = '';
    if (ref) {
      const branch = ref.split('/');
      sourceBranch = branch[branch.length - 1];
    }

    const msg = `\*\*push 提交成功，请及时查看\*\*
      \>提交人：${username}
      \>时间：<font color=\"info\">${dateFormat}</font>
      \>项目：<font color=\"info\">${projectName}</font>
      \>提交分支：<font color=\"info\">${sourceBranch || '未知'}</font>
      \>最后提交信息：<font color=\"info\"> ${lastCommit} </font>
      \>请求链接：[${pushUrl}](${pushUrl})`;

    await ctx.curl(webhook, {
      method: 'POST',
      contentType: 'json',
      data: {
        msgtype: 'markdown',
        markdown: {
          content: msg,
        },
      },
      dataType: 'json',
    });

    await ctx.curl(webhook, {
      method: 'POST',
      contentType: 'json',
      data: {
        msgtype: 'text',
        text: {
          content: `@${username}`,
        },
      },
      dataType: 'json',
    });

    ctx.body = '消息推送成功！';
  } catch (error) {
    console.log(error);
    ctx.body = '请求参数不合法';
  }

}

module.exports = {
  pushEvent,
};
```



**合并事件处理**

```js
'use strict';

const config = require('../../../config/config');
const utils = require('../utils/index');

async function mergeEvent(ctx, webhook, body) {
  try {
    const { user, project, object_attributes } = body;
    const commitPerson = config.commitPeople[user.username] || config.commitPeople[user.name];
    const username = commitPerson && commitPerson.name || user.name || user.username;
    const projectName = project && project.name;
    let stateType = '',
      mergeUrl = '',
      targetBranch = '',
      sourceBranch = '',
      lastCommit = '',
      requestPerson = '',
      dateFormat = '';

    if (object_attributes) {
      const { state, url, created_at, target_branch, source_branch, last_commit } = object_attributes;
      stateType = state;
      mergeUrl = url;
      targetBranch = target_branch;
      sourceBranch = source_branch;
      lastCommit = last_commit ? last_commit.message : '';
      const lastCommitUserArr = lastCommit.match(
        /--user=[a-zA-Z\d\u4e00-\u9fa5]+\s{0,1}/g
      );
      requestPerson =
        lastCommitUserArr && lastCommitUserArr[0]
          ? lastCommitUserArr[0].replace(/--user=/g, '').replace(/\s+/g, '')
          : null;

      // 提交时间
      if (created_at) {
        dateFormat = utils.getDateFormat(created_at);
      }
    }

    const receivers = config.receivers;
    // 验证接收者
    if (!(commitPerson || receivers.includes(username))) {
      return;
    }

    let msg = '';
    let isSend = false;
    switch (stateType) {
      case 'opened':
        // 发起合并请求
        msg = `\*\*发起了一个合并请求，请及时查看\*\*
                \>发起人：${username}
                \>时间：<font color=\"info\">${dateFormat}</font>
                \>项目：<font color=\"info\">${projectName}</font>
                \>来源分支：<font color=\"info\">${sourceBranch}</font>
                \>目标分支：<font color=\"info\">${targetBranch}</font>
                \>最后提交信息：<font color=\"info\">${lastCommit}</font>
                \>请求链接：[${mergeUrl}](${mergeUrl})`;
        isSend = true;
        break;
      case 'merged':
        // 合并成功
        msg = `\*\*合并请求已完成\*\*
                \>发起人：${requestPerson || '未知'}
                \>合并人：${username}
                \>时间：<font color=\"info\">${dateFormat}</font>
                \>项目：<font color=\"info\">${projectName}</font>
                \>来源分支：<font color=\"info\">${sourceBranch}</font>
                \>目标分支：<font color=\"info\">${targetBranch}</font>
                \>最后提交信息：<font color=\"info\">${lastCommit}</font>
                \>请求链接：[${mergeUrl}](${mergeUrl})`;
        isSend = true;
        break;
      case 'closed':
        // 请求关闭
        msg = `\*\*合并请求已关闭\*\*
                \>发起人：${requestPerson || '未知'}
                \>关闭人：${username}
                \>时间：<font color=\"info\">${dateFormat}</font>
                \>项目：<font color=\"info\">${projectName}</font>
                \>来源分支：<font color=\"info\">${sourceBranch}</font>
                \>目标分支：<font color=\"info\">${targetBranch}</font>
                \>最后提交信息：<font color=\"info\">${lastCommit}</font>
                \>请求链接：[${mergeUrl}](${mergeUrl})`;
        isSend = true;
        break;
      default:
        break;
    }

    if (isSend) {
      await ctx.curl(webhook, {
        method: 'POST',
        contentType: 'json',
        data: {
          msgtype: 'markdown',
          markdown: {
            content: msg,
          },
        },
        dataType: 'json',
      });

      await ctx.curl(webhook, {
        method: 'POST',
        contentType: 'json',
        data: {
          msgtype: 'text',
          text: {
            content: `@${username}`,
          },
        },
        dataType: 'json',
      });
      this.ctx.body = '消息推送成功！';
    } else {
      this.ctx.body = '消息类型${stateType}不合法';
    }

  } catch (error) {
    console.error(error);
    this.ctx.body = '请求参数不合法';
  }

}

module.exports = {
  mergeEvent,
};
```



**企业微信机器人配置**

在企业微信机器人群聊中可以直接创建机器人，拿到机器人通知地址，在服务端通过配置需要的标题、文本、图片等字段，请求接口就可以通知到企业微信。

```js
await ctx.curl(webhook, {
  method: 'POST',
  contentType: 'json', // 内容类型
  data: {
    msgtype: 'markdown', // 文本格式 markdown
    markdown: {
      content: msg, // 显示文本
    },
  },
  dataType: 'json'
});
```



**配置界面显示**

[![挂载流程图](https://gitee.com/FIF/pic-beg/raw/master/images/vue/qiyeweixin.png)](https://jefferyxzf.github.io/images/gitlab/qiyeweixin.png)