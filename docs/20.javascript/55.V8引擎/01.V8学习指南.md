---
title: 如何学习谷歌高性能 JavaScript 引擎V8？
date: 2021-05-04 14:27:01
permalink: /pages/sswse3bdeef257ecb
author: 
  name: jeffery
categories: 
  - javascript
  - V8
tags: 
  - javascript
  - V8
---

# 如何学习谷歌高性能 JavaScript 引擎V8？

### 什么是 V8？

`V8` 是 `JavaScript` 虚拟机的一种。我们可以简单地把 `JavaScript` 虚拟机理解成是一个翻译程序，将人类能够理解的**编程语言 JavaScript**，翻译成机器能够理解的**机器语言**。如下图所示：

![img](https://gitee.com/FIF/pic-beg/raw/master/images/javascript/8a40fd003baa9be179fe2e55a1be5fa1.jpg)

上图中，中间的“黑盒”就是 `JavaScript` 引擎 `V8`。目前市面上有很多种 `JavaScript` 引擎，诸如 `SpiderMonkey`、`V8`、`JavaScriptCore` 等。而由谷歌开发的开源项目 `V8` 是当下使用最广泛的 `JavaScript` 虚拟机，全球有超过 25 亿台安卓设备，而这些设备中都使用了 Chrome 浏览器，所以我们写的 `JavaScript` 应用，大都跑在 `V8` 上。

`V8` 之所以拥有如此庞大的生态圈，也和它许多革命性的设计是分不开的。

在 `V8` 出现之前，所有的 `JavaScript` 虚拟机所采用的都是解释执行的方式，这是 `JavaScript` 执行速度过慢的一个主要原因。而 `V8` 率先引入了即时编译（JIT）的双轮驱动的设计，这是一种权衡策略，**混合编译执行和解释执行**这两种手段，给 `JavaScript` 的执行速度带来了极大的提升。

`V8` 出现之后，各大厂商也都在自己的 `JavaScript` 虚拟机中引入了 JIT 机制，所以你会看到目前市面上 `JavaScript` 虚拟机都有着类似的架构。另外，`V8` 也是早于其他虚拟机引入了**惰性编译、内联缓存、隐藏类**等机制，进一步**优化了 JavaScript 代码的编译执行效率**。

可以说，`V8` 的出现，将 `JavaScript` 虚拟机技术推向了一个全新的高度。

**为什么学习 V8？**

如果只是单纯使用 `JavaScript` 和调用 `Web API`，并不了解虚拟机内部是怎样工作的，在项目中遇到的很多问题很可能找不到解决的途径。比如，有时项目的占用内存过高，或者页面响应速度过慢，又或者使用 `Node.js` 的时候导致任务被阻塞等问题，都与 `V8` 的基本运行机制有关。如果熟悉 `V8` 的工作机制，就会有系统性的思路来解决这些问题。

另外，`V8` 的主要功能，就是结合 `JavaScript` 语言的特性和本质来编译执行它。通过深入地学习 `V8`，对 `JavaScript` 语言本质和设计思想会有很直观的感受。这些设计思想像是更加高级的工具，掌握了它，就可以提升在语言使用和架构设计水平。

### 如何学习 V8？

`JavaScript` 借鉴了很多语言的特性，比如 C 语言的基本语法、Java 的类型系统和内存管理、Scheme 的函数作为一等公民，还有 Self 基于原型（prototype）的继承机制。毫无疑问，`JavaScript` 是一门非常优秀的语言，特别是“原型继承机制”和“函数是一等公民”这两个设计。

![img](https://gitee.com/FIF/pic-beg/raw/master/images/javascript/f8fb9e3570b88152f9ab7b6b8d385c7a.jpg)

不过 `JavaScript` 也是一门处处是坑的语言，由于历史原因，很多错误的或者不合理的设计都被延续至今，比如使用 `new` 加构造函数来创建对象，这种方式的背后隐藏了太多的细节，非常容易增加代码出错概率，而且也大大增加了新手的学习成本；再比如初期的 `JavaScript` 没有块级作用域机制，使得 `JavaScript` 需要采取变量提升的策略，而变量提升又是非常反人性的设计。

`V8` 是 `JavaScript` 的实现，在学习 `V8` 工作原理时，我们就要格外关注 `JavaScript` 这些独特的设计思想和特性背后的实现。比如，为了实现函数是一等公民的特性，`JavaScript` 采取了基于对象的策略；再比如为了实现原型继承，`V8` 为每个对象引入了 `__proto__` 属性。

**深入分析过 JavaScript 语言之后，我们就可以学习 V8 执行 JavaScript 代码的完整流程了**。我们把这套流程称之为 `V8` 的编译流水线，其完整流程如下图所示：

![img](https://gitee.com/FIF/pic-beg/raw/master/images/javascript/8a34ae8c1a7a0f87e19b1384a025e354.jpg)

编译流水线本身并不复杂，但是其中涉及到了很多技术，诸如 JIT、延迟解析、隐藏类、内联缓存等等。这些技术决定着一段 `JavaScript` 代码能否正常执行，以及代码的执行效率。

比如 `V8` 中使用的隐藏类（Hide Class），这是将 `JavaScript` 中动态类型转换为静态类型的一种技术，可以消除动态类型的语言执行速度过慢的问题，如果你熟悉 `V8` 的工作机制，在你编写 `JavaScript` 时，就能充分利用好隐藏类这种强大的优化特性，写出更加高效的代码。

再比如，`V8` 实现了 `JavaScript` 代码的惰性解析，目的是为了加速代码的启动速度，通过对惰性解析机制的学习，你可以优化你的代码更加适应这个机制，从而提高程序性能。

要想充分了解 `V8` 是怎么工作的，除了要分析编译流水线，我们还需要了解另外两个非常重要的特性，那就是**事件循环系统**和**垃圾回收机制**。

事件循环系统和 `JavaScript` 中的难点——异步编程特性紧密相关。我们知道，`JavaScript` 是单线程的，`JavaScript` 代码都是在一个线程上执行，如果同一时间发送了多个 `JavaScript` 执行的请求，就需要排队，也就是进行异步编程。

`V8` 的事件循环系统会调度这些排队任务，保证 `JavaScript` 代码被 `V8` 有序地执行。因此也可以说，事件循环系统就是 `V8` 的心脏，它驱动了 `V8` 的持续工作。

另外，`JavaScript` 是一种自动垃圾回收的语言，`V8` 在执行垃圾回收时，会占用主线程的资源，如果我们编写的程序频繁触发垃圾回收，那么无疑会阻塞主线程，这也是我们经常会遇到的一个问题。你需要知道 `V8` 是如何分配内存数据的，以及这些数据是如何被回收的，打通整个链路，建立完整的系统，当下次遇到内存问题时，就知道如何去排查了。

![img](https://static001.geekbang.org/resource/image/90/43/90228d5cc0afbaaa4cca3fbdb1349243.jpg)

**系统学习 V8 的路径**

- 首先，从 `JavaScript` 的设计思想讲起，讨论它背后的一些主要特性，以及 `V8` 是怎么实现这些特性的
- 然后，分析 `V8` 的编译流水线，介绍一些内存分配相关的内容，因为函数调用、变量声明、参数传递或者函数返回数值都涉及到了内存分配。
- 最后，介绍事件循环系统和垃圾回收系统的工作机制。

<!-- ![img](https://gitee.com/FIF/pic-beg/raw/master/images/javascript/2684822c6cb6b453c6f4abb3d89822e3.jpg) -->

### 优质问答区

**1、问：如何提升自己的前端技术**


首先整体知识架构的学习不能断，慢慢持续积累，比如数据结构、操作系统、计算机网络、编译原理等。

另外、公司的业务要积极完成，可以结合业务深入了解下背后的架构设计。

最后、思维方式也特别重要、因为项目有多轻重缓急的任务、写代码的时候也会进程卡住一个地方，这时候就需要有个全局视角，哪些是重要的，哪些可以后期迭代。能能做权衡利弊、权衡权重。产品设计有个MVP原则，你可以了解下，道理是通用的。