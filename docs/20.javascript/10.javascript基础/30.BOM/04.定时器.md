---
title: 定时器
date: 2020-04-14 14:27:01
permalink: /pages/gsdeesaseweew
author: 
  name: jeffery
categories: 
  - javascript
tags: 
  - javascript
---

# 定时器

## setTimeout

`setTimeout()` 方法用来指定某个函数在指定的毫秒数之后执行。它返回一个整数，表示定时器的编号，这个值可以传递给 `clearTimeout()` 用于取消这个定时器

```js
var Timer = setTimeout(function(){
    console.log(Timer);
},1000);
console.log(0);
```

`setTimeout()` 方法可以接收更多的参数，作为回调函数的参数

```js
setTimeout(function(a,b){
  console.log(a+b); // 1 秒后输出 2
},1000,1,1);
```


## setInterval

`setInterval` 的用法与 `setTimeout` 完全一致，区别在于 `setInterval` 每隔一段时间重复执行一次任务，也就是无限次的定时执行

```js
<button id="btn">0</button>
<script>
var timer = setInterval(function(){
    btn.innerHTML = Number(btn.innerHTML) + 1;
},1000);
btn.onclick = function(){
    clearInterval(timer);
    btn.innerHTML = 0;
}
</script>
```

::: tip
HTML5 标准规定，`setTimeout` 的最短时间间隔是4毫秒；`setInterval` 的最短间隔时间是10毫秒，也就是说，小于10毫秒的时间间隔会被调整到10毫秒
:::

大多数电脑显示器的刷新频率是60HZ，大概相当于每秒钟重绘60次。因此，最平滑的动画效的最佳循环间隔是 1000ms/60，约等于16.6ms

为了节电，对于那些不处于当前窗口的页面，浏览器会将时间间隔扩大到1000毫秒。另外，如果笔记本电脑处于电池供电状态，Chrome和IE10+浏览器，会将时间间隔切换到系统定时器，大约是16.6毫秒

## requestAnimationFrame

### 概述

电脑显示器的刷新频率是60Hz，大概相当于每秒钟重绘60次。大多数浏览器都会对重绘操作加以限制，不超过显示器的重绘频率，因为即使超过那个频率用户体验也不会有提升。因此，最平滑动画的最佳循环间隔是1000ms/60，约等于16.6ms

而 `setTimeout` 和 `setInterval` 的问题是，它们都不精确。它们的内在运行机制决定了时间间隔参数实际上只是指定了把动画代码添加到浏览器 UI 线程队列中以等待执行的时间。如果队列前面已经加入了其他任务，那动画代码就要等前面的任务完成后再执行

`requestAnimationFrame` 采用系统时间间隔，保持最佳绘制效率，不会因为间隔时间过短，造成过度绘制，增加开销；也不会因为间隔时间太长，使用动画卡顿不流畅，让各种网页动画效果能够有一个统一的刷新机制，从而节省系统资源，提高系统性能，改善视觉效果

### 特点

- `requestAnimationFrame` 会把每一帧中的所有 `DOM` 操作集中起来，在一次重绘或回流中就完成，并且重绘或回流的时间间隔紧紧跟随浏览器的刷新频率

- 隐藏或不可见的元素中，`requestAnimationFrame` 将不会进行重绘或回流，这当然就意味着更少的 `CPU`、`GPU` 和内存使用量

- `requestAnimationFrame` 是由浏览器专门为动画提供的 `API`，在运行时浏览器会自动优化方法的调用，并且如果页面不是激活状态下的话，动画会自动暂停，有效节省了 `CPU` 开销


### 使用

`requestAnimationFrame` 的用法与 `setTimeout` 很相似，只是不需要设置时间间隔而已。`requestAnimationFrame` 使用一个回调函数作为参数，这个回调函数会在浏览器重绘之前调用。它返回一个整数，表示定时器的编号，这个值可以传递给 `cancelAnimationFrame` 用于取消这个函数的执行

 ```js
 //控制台输出1和0
var timer = requestAnimationFrame(function(){
    console.log(0);
}); 
console.log(timer);//1
 ```

`cancelAnimationFrame` 方法用于取消定时器

```js
//控制台什么都不输出
var timer = requestAnimationFrame(function(){
    console.log(0);
}); 
cancelAnimationFrame(timer);
```

**兼容性处理**

```js
if(!window.requestAnimationFrame){
    var lastTime = 0;
    window.requestAnimationFrame = function(callback){
        var currTime = new Date().getTime();
        var timeToCall = Math.max(0,16.7-(currTime - lastTime));
        var id  = window.setTimeout(function(){
            callback(currTime + timeToCall);
        },timeToCall);
        lastTime = currTime + timeToCall;
        return id;
    }
}

if (!window.cancelAnimationFrame) {
    window.cancelAnimationFrame = function(id) {
        clearTimeout(id);
    };
}
```

## 实现一个动画

### setInterval

::: demo
```html
<template>
<div ref="myDiv1" style="background-color: lightblue;width: 0;height: 20px;line-height: 20px;">0%</div>
<button ref="btn1" @click="run">run</button>
</template>
<script>
var timer;
export default {
  methods: {
      run () {
          const myDiv1 = this.$refs.myDiv1
          const btn1 = this.$refs.btn1
          clearInterval(timer);
            myDiv1.style.width = '0';
            timer = setInterval(function(){
                if(parseInt(myDiv1.style.width) < 500){
                    myDiv1.style.width = parseInt(myDiv1.style.width) + 5 + 'px';
                    myDiv1.innerHTML =     parseInt(myDiv1.style.width)/5 + '%';    
                }else{
                    clearInterval(timer);
                }        
            },16);
      }
  }
}
</script>
```
:::
### setTimeout


::: demo
```html
<template>
<div>
<div ref="myDiv2" style="background-color: lightblue;width: 0;height: 20px;line-height: 20px;">0%</div>
<button ref="btn2" @click="run">run</button>
</div>
</template>

<script>
var timer;
export default {
  methods: {
      run () {
          const myDiv2 = this.$refs.myDiv2
          const btn2 = this.$refs.btn2
          clearTimeout(timer);
            myDiv2.style.width = '0';
            timer = setTimeout(function fn(){
                if(parseInt(myDiv2.style.width) < 500){
                    myDiv2.style.width = parseInt(myDiv2.style.width) + 5 + 'px';
                    myDiv2.innerHTML =     parseInt(myDiv2.style.width)/5 + '%';
                    timer = setTimeout(fn,16);
                }else{
                    clearTimeout(timer);
                }    
            },16);
      }
  }
}
</script>
```
:::

### requestAnimationFrame

::: demo
```html
<template>
    <div>
        <div ref="myDiv3" style="background-color: lightblue;width: 0;height: 20px;line-height: 20px;">0%</div>
        <button ref="btn3" @click="run">run</button>
    </div>
</template>

<script>
var timer;
export default {
  methods: {
      run () {
          const myDiv3 = this.$refs.myDiv3
          const btn3 = this.$refs.btn3
          myDiv3.style.width = '0';
            cancelAnimationFrame(timer);
            timer = requestAnimationFrame(function fn(){
                if(parseInt(myDiv3.style.width) < 500){
                    myDiv3.style.width = parseInt(myDiv3.style.width) + 5 + 'px';
                    myDiv3.innerHTML =     parseInt(myDiv3.style.width)/5 + '%';
                    timer = requestAnimationFrame(fn);
                }else{
                    cancelAnimationFrame(timer);
                }    
            });
      }
  }
}
</script>
```
:::

## 定时器应用

### 时钟

最简单的时钟制作办法是通过正则表达式的 `exec()` 方法，将时间对象的字符串中的时间部分截取出来，使用定时器刷新即可

```html
<div id="myDiv"></div>
<script>
var myDiv = document.getElementById('myDiv')
myDiv.innerHTML = /\d\d:\d\d:\d\d/.exec(new Date().toString())[0];
setInterval(function(){
    myDiv.innerHTML = /\d\d:\d\d:\d\d/.exec(new Date().toString())[0];    
},500);
</script>
```
<common-codepen-snippet :team="false" user="jefferyxzf" title="Event handling" slug="KKmoveN" />


### 倒计时

每 `1s` 通过 `setInterval` 将设置的时间减去 `1` 来达到要求

```html
<div id="myDiv">
    <label for="set"><input type="number" id="set" step="1" value="0">秒</label>
    <button id="btn">确定</button>
    <button id="reset">重置</button>    
</div>
<script>
let btn = document.getElementById('btn')
let reset = document.getElementById('reset')
var timer;
reset.onclick = function(){
    history.go();
}
btn.onclick = function(){
    if(timer) return;
    set.setAttribute('disabled','disabled');
    timer = setInterval(function(){
        if(Number(set.value) === 0){
            clearInterval(timer);
            timer = 0;
            set.removeAttribute('disabled');
            return;
        }
        set.value = Number(set.value) - 1;
    },1000);
}    
</script>
```
<common-codepen-snippet :team="false" user="jefferyxzf" title="Event handling" slug="BaRrdPN" />


**精确倒计时**

由定时器的运行机制，我们知道每间隔 `1000ms` 去改变时间的作法并不可靠。更精确地做法，应该是与系统的运行时间作为参照，倒计时的时间变化与系统的时间变化同步，达到精确倒计时的效果

<common-codepen-snippet :team="false" user="jefferyxzf" title="Event handling" slug="jOmzLvV" />




### 秒表

与倒计时类似，使用计时器的时间间隔作为时间变化的参照是不准确的。更精确的做法，应该是使用系统的时间变化作为秒表的变化的参照

<common-codepen-snippet :team="false" user="jefferyxzf" title="Event handling" slug="eYWMEPe" />

### 闹钟

闹钟其实就是在时钟的基础上增加一个预定时间设置，闹钟设置需要将设置时间转换成距离1970年1月1日的毫秒数，然后再算出与当前时间的差值。随着当前时间的不断增加，当差值为0时，闹钟响起

<common-codepen-snippet :team="false" user="jefferyxzf" title="Event handling" slug="dyWmzqw" />

## 总结

作为定时器来说，最麻烦的地方是定时器管理。如果，定时器只开启不关闭，则会造成定时器叠加效果，使得运行越来越快。所以，先关闭再启用定时器是一个好习惯