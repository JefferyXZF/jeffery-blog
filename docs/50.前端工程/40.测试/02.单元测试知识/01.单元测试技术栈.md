---
title: 单元测试使用指南
date: 2021-06-16 19:03:03
permalink: /pages/yswwedswwewew
author: 
  name: jeffery
categories: 
  - 单元测试
tags: 
  - 单元测试

---

# 单元测试使用指南

单元测试是针对程序的最小单元来进行正确性检验的测试工作。程序单元是应用的最小可测试部件。一个单元可能是单个程序、类、对象、方法等。

## 适用范围

约定针对项目中满足以下条件的函数、组件进行单元测试：

-  输入值、输出值都确定的函数方法 
-  不涉及数据请求、功能粒度小且相对独立的组件 

## 相关工具

项目集成的断言库为 `Jest` ，用法参考官方文档：https://jestjs.io/docs/en/using-matchers
接口请求相关模拟可以使用  `sinon`  ，用法参考文档：https://www.jianshu.com/p/013ab78b92fd
开发过程中踩坑，请参考文档：https://blog.csdn.net/duola8789/article/details/80434962

## 文件目录

单元测试文件存放于在项目 `test/unit/specs` 目录下，以 `xxx.spec.js` 命名。同一模块下的组件，使用统一的目录存放，如针对应用开发模块组件的单元测试，则置于 `test/unit/specs/application` 目录下


目录结构如下：


-  test 
-  e2e   e2e测试，目前暂时不接触 
-  unit   unit测试，即单元测试 
-  coverage   存储覆盖率报告的相关目录 
-  fake       存储测试用相关mock数据的目录 
-  specs     测试用例相关代码目录 
-  form   表单模块相关测试用例代码 
-  utils       工具函数库 

## 单元测试学习资料

**单元测试方案主要用到的技术**： jest 测试库，Vue Test Utils库 和sinon库



**参考资料有以下几种**

- jest： https://jestjs.io/zh-Hans/docs/getting-started
- vue Test Utils： https://vue-test-utils.vuejs.org/zh/

- sinon： https://sinonjs.org/
- 有关Vue.js测试的全面指南：https://www.manning.com/books/testing-vue-js-applications#toc



在开始单元测试之前，可以先了解下什么是测试，测试有什么用？建议开发之前都可以看这篇文章
https://www.manning.com/books/testing-vue-js-applications#toc  

![img](https://gitee.com/FIF/pic-beg/raw/master/images/vue/1626857274472-3e661644-28b6-4c37-b817-c4611220965f.png)





**jest.conf.js的配置说明，提供参考了解, 有理解不对的地方还请告知~~~**
可参考Jest官方文档
https://jestjs.io/zh-Hans/docs/configuration



```js
const path = require('path')
module.exports = {
  // 根目录
  rootDir: path.resolve(__dirname, '../../'),
  //Jest用于检测测试文件的全局模式，会去匹配名为 `spec.js`文件
  testMatch: ['**/__tests__/**/*.[jt]s?(x)', '**/?(*.)+(spec).[jt]s?(x)'],
  // 模块使用的文件扩展名数组
  moduleFileExtensions: [
    'js',
    'jsx',
    'json',
    // 告诉 Jest 处理 *.vue 文件`
    'vue'
  ],
 //支持源代码中相同的 @ -> src 别名!!!!!
  moduleNameMapper: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '\\.(s?css|less)$': 'identity-obj-proxy'

  },
  // 转换：通过正则配置匹配的文件，交给哪个模块处理`
  transform: {
  // 用 babel-jest 处理 js`
    '^.+\\.js$': '<rootDir>/node_modules/babel-jest',
    '.+\\.(css|styl|less|sass|scss|png|jpg|ttf|woff|woff2)$': 'jest-transform-stub',
   //用 vue-jest 处理 *.vue 文件`
    '.*\\.(vue)$': '<rootDir>/node_modules/vue-jest'
  },
  // 忽略
  // 在执行测试之前，与所有测试路径匹配的regexp模式字符串数组。如果测试路径与任何模式匹配，它将被跳过
  testPathIgnorePatterns: [
    '<rootDir>/test/e2e'
  ],
  // Jest应该在快照测试中使用的快照序列化程序模块的路径列表
  snapshotSerializers: ['<rootDir>/node_modules/jest-serializer-vue'],
  setupFiles: ['<rootDir>/test/unit/setup', 'jest-localstorage-mock'],
  // Jest输出覆盖信息文件的目录
  coverageDirectory: '<rootDir>/test/unit/coverage',
  // 是否收集测试时的覆盖率信息(由于要带上覆盖率搜集语句重新访问所有执行过的文件,这会让你的测试执行速度被明显减慢)
  collectCoverage: process.env.PENV === 'coverage',
  // 表明哪些集合的文件是需要收集的,匹配在rootDir下面所有的的文件或目录
  collectCoverageFrom: [
    'src/**/*.{js,vue}',
    '!src/main.js',
    '!src/router/index.js',
    '!**/node_modules/**'
  ],
  //Jest生成覆盖报告的形式
  coverageReporters: ['html', 'text-summary'],
  // 设置jsdom环境的URL
  testURL: 'http://localhost'
}
```



**运行单元测试命令：**
npm run test
npm run test:watch  会监听测试用例文件的修改
npm run test:coverage  会跑测试覆盖率



**vue test utils常用方法:**

```js
const wrapper = mount(DyFormTextBox, { propsData: { config: textBoxData }, localVue })
const vm = wrapper.vm
```

- setProps：设置prop参数， 仿造 Prop`

```
wrapper.setProps({ 参数： 值})
```



1. `find: 寻找第一个DOM节点或Vue组件匹配选择器`



```
wrapper.find('div') 
wrapper.find('#bar')
```



1. `findComponent:： 寻找第一个匹配的Vue组件`



```
wrapper.findComponent({ name: 'bar' })
wrapper.findComponent({ ref: 'bar' })
```



1. `模拟用户交互：使用.trigger()来模拟点击`



```
  const button = wrapper.find('button')
  button.trigger('click')
```



1. 引入插件
   `createLocalVue： 返回一个 Vue 的类供你添加组件、混入和安装插件而不会污染全局的 Vue 类`



```
import ElementUI from 'element-ui'
const localVue = createLocalVue()
localVue.use(ElementUI)
describe('DyFormTextBox', () => {
  const wrapper = mount(DyFormTextBox, { propsData: { config: textBoxData }, localVue })
})
```



1. `mocks： 为实例添加额外的属性`



```
import _g from '@/assets/script/global'
const wrapper = mount(DyFormTextBox, {
  propsData: { config: textBoxData },
  localVue,
  mocks: { $_g: _g }
})
```



1. `provide： 为组件传递用于注入的属性，可查阅 [provide/inject]`



```
import foreignSelectionData from '../../fake/formModel/foreignSelectionData'
const wrapper = mount(dyFormForeignSelection, {
    propsData: { config: foreignSelectionData.config },
    provide: {
      docInfo() {
        return foreignSelectionData.docInfo
      },
      formValidate() {
        return () => {}
      }
    },
    localVue
  })
```



1. ：`emitted： 返回自定义事件`
   文档：https://vue-test-utils.vuejs.org/zh/api/wrapper/#emitted



```
it('input事件可正常触发', async () => {
    await wrapper.setProps({ value: '单行文本' })
    expect(vm.childValue).toBe('单行文本')
    vm.$emit('input')
    expect(wrapper.emitted().input).toBeTruthy()
  })
```



**Sinon.JS常用方法**



1. stubs:  具有预编程行为的功能, 可以是匿名的，也可以包装现有函数。用存根包装现有函数时，不会调用原始函数 （更全用法请参考文档 https://sinonjs.org/releases/v10.0.0/stubs/）
   `var stub = sinon.stub();`
   创建一个匿名存根函数
   `var stub = sinon.stub(object, "method");`
   替换 `object.method` 为存根函数。如果该属性还不是函数，则抛出异常
   `stub.resolves(value);`
   使存根返回一个Promise，该Promise解析为提供的值



外键选择测试用例：获取字段列表数据请求正常



```
import { formModelApi } from '@/api/api'
 const foreignOptions = {
  list: _g.cloneDeep([{
    id: '__empty__',
    relateField: {
      key_1: {
        fieldName: '无',
        fieldValue: '无'
      }
    },
    showFields: {}
  }])
}
const getFieldsList = sinon.stub(formModelApi, 'getFieldsList')
getFieldsList.resolves({
  status: 200,
  data: {
    code: 0,
    data: foreignOptions
  }
})
describe('foreignListPage', () => {
	it('获取字段列表数据请求正常', async() => {
		setTimeout(() => {
		  expect(vm.foreignData).toEqual(foreignOptions)
		}, 0)
	 })
})
```



**开发遇到的问题记录1：**



-  描述问题：外键页面，有引入子组件dmForeignSelection，而子组件是在src\views\components\index.js 全局注册 的。因此在写外键测试用例的时候会报此组件未注册 
-  解决方案：在测试用例注册dmForeignSelection 



```
import { createLocalVue } from '@vue/test-utils'
import dmForeignSelection from '@/views/components/dmForeignSelection/index'
const localVue = createLocalVue()
localVue.component('dmForeignSelection', dmForeignSelection)
```

------

运行端的组件测试用例汇总：

| 组件名   | 测试用例.js                    | 数量 | 是否自测通过      |
| -------- | ------------------------------ | ---- | ----------------- |
| 单行文本 | dyFormTextBox.spec.js          | 10   | npm run test 通过 |
| 外键选择 | dyFormForeignSelection.spec.js | 4    | npm run test 通过 |