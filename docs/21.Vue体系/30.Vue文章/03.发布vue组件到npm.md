---
author: 
  name: jeffery
  link: https://github.com/JefferyXZF
title: 发布vue组件到npm
date: 2021-05-20 14:40:19
permalink: /pages/8see6f7bdd71c59
categories: 
  - Vue文章
  - npm
  - vue-cli
tags: 
  - Vue文章
  - npm
  - vue-cli
---

# 发布vue组件到npm

## 开发vue组件

### 安装环境

全局安装 vue-cli ，具体配置查看 [vue-cli官方文档](https://cli.vuejs.org/zh/guide/installation.html)

```shell
npm install -g @vue/cli
```

`vue -V` 查看是否安装成功

![image-20210812165855923](https://gitee.com/FIF/pic-beg/raw/master/images/vue/image-20210812165855923.png)

::: warning
若报错：`bash: vue: command not found` ；是因为没找到按照的 vue，到安装目录下运行 `vue -V`，查看是否安装成功，若成功，但是其他目录还报错，请查找一下环境变量是否配置正确；若还是无法解决请卸载node,vue,vue-cli重新安装
:::

### 创建项目

在指定目录中使用命令创建一个默认的项目，或者根据自己需要自己选择项目名

```shell
vue creat .
```

创建过程中需要选择要安装的依赖，可以选择默认的 `default(babel,eslint)`也可以选择 `Maually select features`  自己定义配置



### 修改目录并配置webpack

![image-20210812185846165](https://gitee.com/FIF/pic-beg/raw/master/images/vue/image-20210812185846165.png)

- src -> examples 用于放置示例文件
- 增加 packages 用于编写存放组件
- 增加 lib 文件夹 用户放置打包后的文件
- 增加 vue.config.js 文件 用于配置webpack



**1、配置项目以支持新的目录结构**

项目目录修改后，会遇到两个问题。

1. `src`目录更名为`examples`，导致项目无法运行
2. 新增`packages`目录，该目录未加入`webpack`编译

::: tip

cli 提供一个可选的 **`vue.config.js`** 配置文件。如果这个文件存在则他会被自动加载，所有的对项目和webpack的配置，都在这个文件中

:::

Vue CLI 支持使用 `vue.config.js` 中的 `pages` 选项构建一个多页面的应用。

这里使用 `pages` 修改入口到 `examples`



**2、支持对 packages 目录的处理，修改配置中的 chainWebpack**

`packages` 是我们新增的一个目录，默认是不被 webpack 处理的，所以需要添加配置对该目录的支持。

`chainWebpack` 是一个函数，会接收一个基于 `webpack-chain` 的 `ChainableConfig` 实例。允许对内部的 `webpack` 配置进行更细粒度的修改。

```js
module.exports = {
    // 修改 src 为 examples
    pages: {
        index: {
            entry: 'examples/main.js',
            template: 'public/index.html',
            filename: 'index.html'
        }
    },
    css: {
        extract: false,
    },
    // 扩展 webpack 配置，使 packages 加入编译
    chainWebpack: config => {
        config.module
            .rule('js')
            .include
            .add('/packages')
            .end()
            .use('babel')
            .loader('babel-loader')
            .tap(options => {
                // 修改它的选项...
                return options;
            });
    }
};
```

[链式操作](https://link.zhihu.com/?target=https%3A//cli.vuejs.org/zh/guide/webpack.html%23%E9%93%BE%E5%BC%8F%E6%93%8D%E4%BD%9C-%E9%AB%98%E7%BA%A7)

[webpack-chain](https://link.zhihu.com/?target=https%3A//github.com/mozilla-neutrino/webpack-chain)

### 编写组件

**1、创建一个新组件**

- 在 `packages` 目录下，所有的单个组件都以文件夹的形式存储，所以在这里创建一个目录 `custom-print`

- 在 `custom-print` 目录下创建 `src` 目录存储组件源码
- 在 `custom-print` 目录下创建 `index.js` 文件对外提供对组件的引用。

![image-20210812192010591](https://gitee.com/FIF/pic-beg/raw/master/images/vue/image-20210812192010591.png)

修改 `/packages/custom-print/index.js`文件，对外提供引用。

```js
# /packages/custom-print/index.js
// 导入组件，组件必须声明 name
import customPrint from './src/custom-print.vue'

// 为组件提供 install 安装方法，供按需引入
customPrint.install = function (Vue) {
  Vue.component(customPrint.name, customPrint)
}

// 默认导出组件
export default customPrint
```



**2、整合所有的组件，对外导出，即一个完整的组件库**

修改 `/packages/index.js` 文件，对整个组件库进行导出。

```js
// 自定义打印组件
import customPrint from './custom-print/index.js'

// 存储组件列表
const components = [
  customPrint
]

// 定义 install 方法，接收 Vue 作为参数。如果使用 use 注册插件，则所有的组件都将被注册
const install = function (Vue) {
  // 判断是否安装
  if (install.installed) return
  // 遍历注册全局组件
  components.map(component => Vue.component(component.name, component))
}

// 判断是否是直接引入文件
if (typeof window !== 'undefined' && window.Vue) {
  install(window.Vue)
}

export default {
  // 导出的对象必须具有 install，才能被 Vue.use() 方法安装
  install,
  // 以下是具体的组件列表
  customPrint
}
```

### 编写示例

**1、在示例中导入组件库**

```js
import Vue from 'vue'
import App from './App.vue'

// 导入组件库
import components from './../packages/index.js'

// 注册组件库
Vue.use(components)

Vue.config.productionTip = false

new Vue({
  render: h => h(App)
}).$mount('#app')
```



**2、在示例中使用组件库中的组件**

在上一步用使用 `Vue.use()` 全局注册后，即可在任意页面直接使用了，而不需另外引入。当然也可以按需引入。

```html
<template>
  <div id="app">
    <custom-print />
  </div>
</template>

<script>

export default {
  name: 'App',
  data () {
    return {

    }
  }

}
</script>
```

##  发布npm

### 配置 `package.json` 文件编译库

在`package.json`中`main`属性设置为`dist`目录下的文件，则需要对 `build` 命令做相应的配置（`package.json`文件中）

::: tip

如果在`package.json`中`main`属性设置为目录`lib`下的文件（比如 `lib/vue-print-handsontable.umd.min.js`）,那么需要需改一些配置。
 因为默认的`npm run build`命令后生成在`dist`目录下的文件名默认是长这样的：`app.[hash:8].js`，中间有8位的随机生成的哈希值。

:::



```json
"script": {
	// ...
	"lib": "vue-cli-service build --target lib --name vue-print-handsontable --dest lib packages/index.js"
}
```

该命令的参数解释如下（摘自[官方文档](https://cli.vuejs.org/zh/guide/cli-service.html#vue-cli-service-build)）

```shell
用法：vue-cli-service build [options] [entry|pattern]

选项：

  --mode        指定环境模式 (默认值：production)
  --dest        指定输出目录 (默认值：dist)
  --modern      面向现代浏览器带自动回退地构建应用
  --target      app | lib | wc | wc-async (默认值：app)
  --name        库或 Web Components 模式下的名字 (默认值：package.json 中的 "name" 字段或入口文件名)
  --no-clean    在构建项目之前不清除目标目录
  --report      生成 report.html 以帮助分析包内容
  --report-json 生成 report.json 以帮助分析包内容
  --watch       监听文件变化

```



**执行编译库命令**

```text
$ npm run lib
```

![image-20210812195253191](https://gitee.com/FIF/pic-beg/raw/master/images/vue/image-20210812195253191.png)

### 配置 `package.json` 文件中发布到 npm

- `name`: 包名，该名字是唯一的。可在 npm 官网搜索名字，如果存在则需换个名字。
- `version`: 版本号，每次发布至 npm 需要修改版本号，不能和历史版本号相同。
- `description`: 描述。
- `main`: 入口文件，该字段需指向我们最终编译后的包文件。
- `keyword`：关键字，以空格分离希望用户最终搜索的词。
- `author`：作者
- `private`：是否私有，需要修改为 false 才能发布到 npm
- `license`： 开源协议

```json
 { 
    "name": "vue-print-handsontable",//包名，该名不能和已有的名称冲突；
    "version":"0.1.0", //版本号，不能和历史版本号相同；
    "description":"vue print with handsontable",// 简介；
    "main":"lib/vue-print-handsontable.umd.min.js", //入口文件，应指向编译后的包文件；
    "keyword":"vue print handsontable",//关键字，以空格分割；
    "author":"jefferyxzf",//作者；
    "private":false,//是否私有，需要修改为 false 才能发布到 npm；
    "license":"MIT",//开源协议。
    ...
    }
```

### 添加 `.npmignore` 文件，设置忽略发布文件

```shell
# 忽略目录
examples/
packages/
public/

# 忽略指定文件
vue.config.js
babel.config.js
*.map
```

### 登录到 npm

首先需要到 npm 上注册一个账号[www.npmjs.com](https://link.juejin.cn?target=https%3A%2F%2Fwww.npmjs.com)，注册过程略。

如果配置了淘宝镜像，先设置回npm镜像：

```shell
$ npm config set registry http://registry.npmjs.org
```

然后在终端执行登录命令，输入用户名、密码、邮箱即可登录。

```shell
$ npm login
```

![image-20210812200514002](https://gitee.com/FIF/pic-beg/raw/master/images/vue/image-20210812200514002.png)

### 发布到 npm

执行发布命令，发布组件到 npm

```text
$ npm publish
```



![image-20210812200654340](https://gitee.com/FIF/pic-beg/raw/master/images/vue/image-20210812200654340.png)

### 发布成功

发布成功后稍等几分钟，即可在 npm 官网搜索到。以下是刚提交的 `vue-print-hansandtable`

![image-20210812200845724](https://gitee.com/FIF/pic-beg/raw/master/images/vue/image-20210812200845724.png)



## 使用新发布的组件库

安装

```shell
$ npm install vue-print-handsontable -S
```

使用

```html
<template>
  <customPrint />
</template>
<script>
  # 在 main.js 引入并注册
  import { customPrint } from 'vue-print-handsontable'
  Vue.use(customPrint)
  export default {
    components: {
        customPrint
    }
  }
</script>
```



### 发布时可能遇到的问题

- 1、需要修改地址，一般为了下载速度快会改为`npm config set registry https://registry.npm.taobao.org`，但发布npm包时必须为npm的地址：`npm config set registry http://registry.npmjs.org/`

```
npm ERR! code E403
npm ERR! 403 Forbidden - PUT https://registry.npm.taobao.org/vue-short-cut - [no_perms] Private mode enable, only admin can publish this module
```

- 2、包重名，修改package.json中的name

```
npm ERR! publish Failed PUT 403
npm ERR! code E403
npm ERR! You do not have permission to publish "vue-short-cut". Are you logged in as the correct user?
```

- 3、若包名与现有的包很相似，会提示修改包名，修改package.json中的name,并运行`npm publish --access=public`

```
npm ERR! code E403
npm ERR! 403 Forbidden - PUT http://registry.npmjs.org/vue-short-cut - Package name too similar to existing packages; try renaming your package to '@logmei/vue-short-cut' and publishing with 'npm publish --access=public' instead
```

- 4、版本不允许重复，需要修改package.json中的version

```
npm ERR! code E403
npm ERR! 403 Forbidden - PUT http://registry.npmjs.org/@logmei%2fvue-short-cut - You cannot publish over the previously published versions: 0.1.2.
```

- 5、如果想撤销发布的npm包（注意不要随意撤销包） npm unpublish @logmei/vue-short-cut --force

> 根据规范，只有在发包的24小时内才允许撤销发布的包（ unpublish is only allowed with versions published in the last 24 hours）； 即使你撤销了发布的包，发包的时候也不能再和被撤销的包的名称和版本重复了（即不能名称相同，版本相同，因为这两者构成的唯一标识已经被“占用”了）



## 参考文章

[从零开始搭建Vue组件库 VV-UI](https://zhuanlan.zhihu.com/p/30948290)

[vue-cli v3.10创建项目、发布npm包并踩坑解决](https://juejin.cn/post/6844903911816593421)